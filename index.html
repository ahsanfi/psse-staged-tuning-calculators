<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staged Tuning Calculators</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .card {
            background-color: #1F2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .input-field {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4B5563; /* border-gray-600 */
            color: #F9FAFB; /* text-gray-50 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem; /* p-3 */
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3B82F6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px #1E40AF; /* focus:ring-blue-500/50 */
        }
        .input-field[readonly] {
            background-color: #4B5563; /* bg-gray-600 */
            cursor: not-allowed;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: #2563EB; /* bg-blue-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #1D4ED8; /* hover:bg-blue-700 */
        }
        .btn-secondary {
            background-color: #4B5563; /* bg-gray-600 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #6B7280; /* hover:bg-gray-500 */
        }
        .step-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #374151;
        }
        .result-box {
             background-color: #111827;
             padding: 1rem;
             border-radius: 0.5rem;
             border: 1px solid #4B5563;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            color: #9CA3AF; /* text-gray-400 */
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background-color: #374151; /* hover:bg-gray-700 */
            color: #F9FAFB; /* hover:text-gray-50 */
        }
        .tab-btn.active {
            color: #3B82F6; /* text-blue-500 */
            border-bottom-color: #3B82F6;
            background-color: #1F2937;
        }
        .calculator-content {
            display: none;
        }
        .calculator-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto max-w-6xl px-4 py-8 sm:py-12">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Staged Tuning Calculators</h1>
            <p class="mt-3 text-lg text-gray-400 max-w-3xl mx-auto">A collection of tools for generator tuning. Select a calculator below.</p>
        </header>

        <!-- TABS -->
        <div class="mb-8 border-b border-gray-700">
            <nav class="flex justify-center -mb-px space-x-4" aria-label="Tabs">
                <button class="tab-btn active" id="tab-multi">Multi-Generator</button>
                <button class="tab-btn" id="tab-single">Single Generator</button>
            </nav>
        </div>

        <!-- MULTI-GENERATOR CALCULATOR CONTENT -->
        <div id="multiGenCalc" class="calculator-content active">
            <main class="space-y-10">
                <div class="card p-6 border-2 border-indigo-500">
                    <h2 class="step-header text-indigo-400">Global Targets</h2>
                    <p class="text-sm text-gray-400 mb-4">Enter your final POI targets here. They will be automatically used in all steps below.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="global_p_target" class="block text-sm font-medium text-gray-300 mb-1">üéØ Final Target POI P Output (MW)</label>
                            <input type="number" id="global_p_target" class="input-field" placeholder="e.g., -216.0000">
                        </div>
                        <div>
                            <label for="global_q_target" class="block text-sm font-medium text-gray-300 mb-1">üéØ Final Target POI Q Output (Mvar)</label>
                            <input type="number" id="global_q_target" class="input-field" placeholder="e.g., 0.0000">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="step-header text-purple-400">Configuration</h2>
                     <label for="num_generators" class="block text-sm font-medium text-gray-300 mb-1">Number of Generators</label>
                    <select id="num_generators" class="input-field bg-gray-700 w-full md:w-1/4">
                        <option value="2" selected>2 Generators</option>
                        <option value="3">3 Generators</option>
                        <option value="4">4 Generators</option>
                    </select>
                </div>
    
                <div class="card p-6">
                    <h2 class="step-header text-cyan-400">Generator Load Ratio</h2>
                    <p class="text-sm text-gray-400 mb-4">Set the load distribution between the generators. The total must be 100%.</p>
                    <div id="ratio_container" class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="resetAllBtn" class="btn bg-red-600 hover:bg-red-700 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466"/>
                        </svg>
                        <span>Reset All</span>
                    </button>
                </div>
                
                <!-- STEP 1: PGen TUNING -->
                <div class="card p-6">
                    <h2 class="step-header">Step 1: Initial PGen Estimation</h2>
                    <p class="text-sm text-gray-400 mb-6">Goal: Find the `PGen Input` for all generators based on the defined ratio. Hold `VSched Input` constant.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div>
                                <label for="p_out_target_s1" class="block text-sm font-medium text-gray-300 mb-2">üéØ **Target POI P Output (MW)**</label>
                                <input type="number" id="p_out_target_s1" class="input-field" placeholder="Set in Global Targets" readonly>
                            </div>
                            <div class="space-y-4">
                                <h3 class="font-semibold text-white">Data from 2 PGen Simulations:</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-green-400 mb-2">Simulation A</p>
                                        <div id="p_in_A_container" class="space-y-2 mb-2"></div>
                                        <label class="text-xs text-gray-400 block">VSched In (All)</label><input type="number" class="input-field mt-1" value="1.000">
                                        <label class="text-xs text-gray-400 mt-2 block">POI P Output (MW)</label><input type="number" id="p_out_A" class="input-field mt-1" placeholder="Total P at POI">
                                    </div>
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-green-400 mb-2">Simulation B</p>
                                        <div id="p_in_B_container" class="space-y-2 mb-2"></div>
                                        <label class="text-xs text-gray-400 block">VSched In (All)</label><input type="number" class="input-field mt-1" value="1.000">
                                        <label class="text-xs text-gray-400 mt-2 block">POI P Output (MW)</label><input type="number" id="p_out_B" class="input-field mt-1" placeholder="Total P at POI">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col">
                             <div class="space-y-4">
                                <button id="calculatePBtn" class="btn btn-primary w-full">Calculate Estimated PGen Input</button>
                                <button id="resetPBtn" class="btn btn-secondary w-full">Reset</button>
                            </div>
                            <div id="pResultCard" class="mt-6 p-6 flex-grow flex flex-col justify-center items-center bg-gray-900 rounded-lg border border-gray-700 hidden">
                                 <h3 class="font-semibold text-white mb-3 text-center">‚úÖ Est. PGen Inputs:</h3>
                                 <div id="p_result_container" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                     <!-- Dynamically populated -->
                                 </div>
                                 <p id="pErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                                 <div id="pNextStep" class="mt-4 w-full text-center text-sm text-gray-400 hidden">
                                    <button id="useForStep2Btn" class="btn btn-primary w-full text-sm">‚û°Ô∏è Use these PGen values for Step 2</button>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- STEP 2: QGen TUNING -->
                <div class="card p-6">
                    <h2 class="step-header">Step 2: Initial VSched Estimation</h2>
                    <p class="text-sm text-gray-400 mb-6">Use the `PGen Inputs` from Step 1. Find the symmetrical `VSched Input` to meet the `POI Q Output` target.</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">‚ö° **PGen Inputs (constant, from Step 1)**</label>
                                <div id="p_in_s2_container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                            <div>
                                <label for="q_out_target_s2" class="block text-sm font-medium text-gray-300 mb-2">üéØ **Target POI Q Output (Mvar)**</label>
                                <input type="number" id="q_out_target_s2" class="input-field" placeholder="Set in Global Targets" readonly>
                            </div>
                             <div class="space-y-4 md:col-span-2">
                                 <div class="flex items-center mb-4">
                                    <input id="symm_v_s2" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <label for="symm_v_s2" class="ml-2 block text-sm text-gray-300">Symmetrical VSched Inputs</label>
                                </div>
                                <h3 class="font-semibold text-white">Data from 2 VSched Simulations:</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-yellow-400 mb-2">Simulation C</p>
                                        <div id="v_in_C_container" class="space-y-2 mb-2"></div>
                                        <label class="text-xs text-gray-400 mt-2 block">POI Q Output (Mvar)</label><input type="number" id="q_out_C" class="input-field mt-1" placeholder="Total Q at POI">
                                    </div>
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-yellow-400 mb-2">Simulation D</p>
                                        <div id="v_in_D_container" class="space-y-2 mb-2"></div>
                                        <label class="text-xs text-gray-400 mt-2 block">POI Q Output (Mvar)</label><input type="number" id="q_out_D" class="input-field mt-1" placeholder="Total Q at POI">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col">
                             <div class="space-y-4">
                                <button id="calculateQBtn" class="btn btn-primary w-full">Calculate Estimated VSched Input</button>
                                 <button id="resetQBtn" class="btn btn-secondary w-full">Reset</button>
                            </div>
                            <div id="qResultCard" class="mt-6 p-6 flex-grow flex flex-col justify-center items-center bg-gray-900 rounded-lg border border-gray-700 hidden">
                                 <h3 class="font-semibold text-white mb-3 text-center">‚úÖ Est. Symmetrical VSched Input (per Gen):</h3>
                                 <div class="result-box text-center">
                                    <p id="v_in_result" class="text-3xl font-bold text-yellow-400">-</p>
                                    <p class="text-sm text-gray-500">pu</p>
                                 </div>
                                 <p id="qErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                                 <button id="useForStep3Btn" class="btn btn-primary mt-4 w-full text-sm bg-indigo-600 hover:bg-indigo-700">Use these values for Step 3</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 3: FINAL CORRECTION -->
                <div class="card p-6 border-2 border-blue-500">
                    <h2 class="step-header text-blue-400">Step 3: Final Correction</h2>
                    <p class="text-sm text-gray-400 mb-6">Calculates the final PGen and VSched inputs to precisely match both P and Q targets, accounting for coupling effects.</p>
                    
                    <div class="mb-6">
                        <h3 class="font-semibold text-white mb-2">üéØ Your Final POI Targets</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-900 p-4 rounded-lg">
                            <div>
                                <label for="p_out_target_s3" class="block text-sm font-medium text-gray-300 mb-1">Target POI P Output (MW)</label>
                                <input type="number" id="p_out_target_s3" class="input-field" placeholder="Set in Global Targets" readonly>
                            </div>
                            <div>
                                <label for="q_out_target_s3" class="block text-sm font-medium text-gray-300 mb-1">Target POI Q Output (Mvar)</label>
                                <input type="number" id="q_out_target_s3" class="input-field" placeholder="Set in Global Targets" readonly>
                            </div>
                        </div>
                    </div>
    
                    <div>
                         <h3 class="font-semibold text-white mb-2">Data from 3 Correction Simulations:</h3>
                         <p class="text-xs text-gray-400 mb-4">Start from your last condition (results from Steps 1 & 2), then slightly change the PGen and VSched inputs to get sensitivity data.</p>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Sim E (Current Condition)</p>
                                 <div id="p_in_E_container" class="space-y-2 mb-2"></div>
                                 <label class="text-xs">Symmetrical VSched In</label><input type="number" id="v_in_E" class="input-field my-1" placeholder="Current VSched In">
                                 <label class="text-xs">POI P Out</label><input type="number" id="p_out_E" class="input-field my-1" placeholder="Current POI P Out">
                                 <label class="text-xs">POI Q Out</label><input type="number" id="q_out_E" class="input-field my-1" placeholder="Current POI Q Out">
                            </div>
                            <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Sim F (Change PGen In)</p>
                                 <div id="p_in_F_container" class="space-y-2 mb-2"></div>
                                 <label class="text-xs">POI P Out</label><input type="number" id="p_out_F" class="input-field my-1" placeholder="Resulting POI P">
                                 <label class="text-xs">POI Q Out</label><input type="number" id="q_out_F" class="input-field my-1" placeholder="Resulting POI Q">
                            </div>
                             <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Sim G (Change VSched In)</p>
                                 <label class="text-xs">Symmetrical VSched In</label><input type="number" id="v_in_G" class="input-field my-1" placeholder="VSched In + change">
                                 <label class="text-xs">POI P Out</label><input type="number" id="p_out_G" class="input-field my-1" placeholder="Resulting POI P">
                                 <label class="text-xs">POI Q Out</label><input type="number" id="q_out_G" class="input-field my-1" placeholder="Resulting POI Q">
                            </div>
                         </div>
                    </div>
                    
                    <div class="mt-6 flex flex-col md:flex-row gap-4">
                         <button id="calculateFinalBtn" class="btn btn-primary w-full bg-blue-600 hover:bg-blue-700">Calculate Final Correction</button>
                         <button id="resetFinalBtn" class="btn btn-secondary w-full">Reset</button>
                    </div>
    
                    <div id="finalResultCard" class="mt-6 p-6 bg-gray-900 rounded-lg border border-gray-700 hidden">
                        <h3 class="font-semibold text-white mb-4 text-center">üèÜ Recommended Final Inputs:</h3>
                        <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                            <div id="p_final_result_container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Dynamically populated -->
                            </div>
                            <div class="result-box text-center">
                                <p class="text-sm font-medium text-gray-400">Final VSched Input</p>
                                <p id="v_in_final_result" class="text-3xl font-bold text-yellow-400 mt-1">-</p>
                                <p class="text-sm text-gray-500">pu</p>
                            </div>
                        </div>
                        <p id="finalErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                    </div>
                </div>
    
                <!-- UTILITY: Qmax Calculator -->
                <div class="card p-6">
                    <h2 class="step-header">Utility: Qmax Calculator (per Generator)</h2>
                    <p class="text-sm text-gray-400 mb-4">Calculate the Qmax value for a single generator based on the formula: Qmax = ‚àö(S¬≤ - P¬≤).</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="qmax_s" class="block text-sm font-medium text-gray-300 mb-1">Apparent Power (S) in MVA</label>
                            <input type="number" id="qmax_s" class="input-field" placeholder="e.g., 222.2">
                        </div>
                        <div>
                            <label for="qmax_p" class="block text-sm font-medium text-gray-300 mb-1">Active Power (P) in MW</label>
                            <input type="number" id="qmax_p" class="input-field" placeholder="e.g., 200.0">
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mt-4">
                        <button id="calculateQmaxBtn" class="btn btn-primary bg-purple-600 hover:bg-purple-700">Calculate Qmax</button>
                        <button id="resetQmaxBtn" class="btn btn-secondary">Reset</button>
                    </div>
                    <div id="qmaxResultCard" class="mt-6 hidden">
                        <div class="bg-gray-900 p-4 rounded-lg border border-purple-500/50 inline-block">
                            <p class="text-sm font-medium text-gray-400">Qmax Result</p>
                            <p id="qmax_result" class="text-2xl font-bold text-purple-400 mt-1">-</p>
                            <p class="text-sm text-gray-500">Mvar</p>
                        </div>
                        <p id="qmaxErrorMessage" class="mt-2 text-red-400 text-sm font-medium"></p>
                    </div>
                </div>
            </main>
        </div>


        <!-- SINGLE GENERATOR CALCULATOR CONTENT -->
        <div id="singleGenCalc" class="calculator-content">
             <main class="space-y-10">
                <div class="text-center">
                    <button id="sg_resetAllBtn" class="btn bg-red-600 hover:bg-red-700 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466"/>
                        </svg>
                        <span>Reset All</span>
                    </button>
                </div>
                <div class="card p-6 border-2 border-green-500">
                    <h2 class="step-header text-green-400">Global Targets</h2>
                    <p class="text-sm text-gray-400 mb-6">Define your final PGen and QGen targets here. These values will be used throughout the calculation steps.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="sg_p_out_target_global" class="block text-sm font-medium text-gray-300 mb-1">üéØ Target PGen Output (MW)</label>
                            <input type="number" id="sg_p_out_target_global" class="input-field" placeholder="e.g., -108.0000">
                        </div>
                        <div>
                            <label for="sg_q_out_target_global" class="block text-sm font-medium text-gray-300 mb-1">üéØ Target QGen Output (Mvar)</label>
                            <input type="number" id="sg_q_out_target_global" class="input-field" placeholder="e.g., 0.0000">
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="step-header">Step 1: Initial PGen Estimation</h2>
                    <p class="text-sm text-gray-400 mb-6">Enter data from two simulations to estimate the required `PGen Input` for your global target. Ensure `VSched Input` is constant for this step.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div class="space-y-4">
                                <h3 class="font-semibold text-white">Data from 2 PGen Simulations:</h3>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="font-medium text-green-400 mb-2">Simulation A</p>
                                    <label class="text-xs text-gray-400">PGen Input (MW)</label>
                                    <input type="number" id="sg_p_in_A" class="input-field mt-1" placeholder="Initial PGen value">
                                    <label class="text-xs text-gray-400 mt-2 block">VSched Input (pu)</label>
                                    <input type="number" class="input-field mt-1" placeholder="e.g., 1.000" value="1.000">
                                    <label class="text-xs text-gray-400 mt-2 block">PGen Output (MW)</label>
                                    <input type="number" id="sg_p_out_A" class="input-field mt-1" placeholder="Resulting PGen output">
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="font-medium text-green-400 mb-2">Simulation B</p>
                                    <label class="text-xs text-gray-400">PGen Input (MW)</label>
                                    <input type="number" id="sg_p_in_B" class="input-field mt-1" placeholder="Second PGen value">
                                    <label class="text-xs text-gray-400 mt-2 block">VSched Input (pu)</label>
                                    <input type="number" class="input-field mt-1" placeholder="e.g., 1.000" value="1.000">
                                    <label class="text-xs text-gray-400 mt-2 block">PGen Output (MW)</label>
                                    <input type="number" id="sg_p_out_B" class="input-field mt-1" placeholder="Second resulting PGen output">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col">
                             <div class="space-y-4">
                                <button id="sg_calculatePBtn" class="btn btn-primary w-full">Calculate Estimated PGen Input</button>
                                <button id="sg_resetPBtn" class="btn btn-secondary w-full">Reset Step 1</button>
                            </div>
                            <div id="sg_pResultCard" class="mt-6 p-6 flex-grow flex flex-col justify-center items-center bg-gray-900 rounded-lg border border-gray-700 hidden">
                                 <h3 class="font-semibold text-white mb-3 text-center">‚úÖ Estimated PGen Input:</h3>
                                 <div class="result-box text-center">
                                    <p id="sg_p_in_result" class="text-3xl font-bold text-green-400">-</p>
                                    <p class="text-sm text-gray-500">MW</p>
                                 </div>
                                 <p id="sg_pErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                                 <div id="sg_pNextStep" class="mt-4 text-center text-sm text-gray-400 hidden">
                                    <p>‚û°Ô∏è Now, use this PGen value as a constant input for your Step 2 simulations.</p>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="step-header">Step 2: Initial VSched Estimation</h2>
                    <p class="text-sm text-gray-400 mb-6">Use the `PGen Input` from Step 1 as a constant. Now, find the `VSched Input` to meet the global `QGen Output` target. PGen Output may drift slightly.</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div>
                                <label for="sg_p_in_s2" class="block text-sm font-medium text-gray-300 mb-2">‚ö° **PGen Input from Step 1 (constant)**</label>
                                <input type="number" id="sg_p_in_s2" class="input-field" placeholder="Enter calculated PGen from Step 1">
                            </div>
                            <div class="space-y-4">
                                 <h3 class="font-semibold text-white">Data from 2 VSched Simulations:</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-yellow-400 mb-2">Simulation C</p>
                                        <label class="text-xs text-gray-400">VSched Input (pu)</label>
                                        <input type="number" id="sg_v_in_C" class="input-field mt-1" placeholder="Initial VSched value">
                                        <label class="text-xs text-gray-400 mt-2 block">QGen Output (Mvar)</label>
                                        <input type="number" id="sg_q_out_C" class="input-field mt-1" placeholder="Resulting QGen output">
                                    </div>
                                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                        <p class="font-medium text-yellow-400 mb-2">Simulation D</p>
                                        <label class="text-xs text-gray-400">VSched Input (pu)</label>
                                        <input type="number" id="sg_v_in_D" class="input-field mt-1" placeholder="Second VSched value">
                                        <label class="text-xs text-gray-400 mt-2 block">QGen Output (Mvar)</label>
                                        <input type="number" id="sg_q_out_D" class="input-field mt-1" placeholder="Second resulting QGen output">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col">
                             <div class="space-y-4">
                                <button id="sg_calculateQBtn" class="btn btn-primary w-full">Calculate Estimated VSched Input</button>
                                 <button id="sg_resetQBtn" class="btn btn-secondary w-full">Reset Step 2</button>
                            </div>
                            <div id="sg_qResultCard" class="mt-6 p-6 flex-grow flex flex-col justify-center items-center bg-gray-900 rounded-lg border border-gray-700 hidden">
                                 <h3 class="font-semibold text-white mb-3 text-center">‚úÖ Estimated VSched Input:</h3>
                                 <div class="result-box text-center">
                                    <p id="sg_v_in_result" class="text-3xl font-bold text-yellow-400">-</p>
                                    <p class="text-sm text-gray-500">pu</p>
                                 </div>
                                 <p id="sg_qErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                                 <button id="sg_useForStep3Btn" class="btn btn-primary mt-4 w-full text-sm bg-indigo-600 hover:bg-indigo-700">Use these values for Step 3</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card p-6 border-2 border-blue-500">
                    <h2 class="step-header text-blue-400">Step 3: Final Correction Calculator</h2>
                    <p class="text-sm text-gray-400 mb-6">Use this for high-precision results, accounting for P-Q coupling. It will calculate the final adjustment needed to meet both global targets simultaneously.</p>
                    <div>
                         <h3 class="font-semibold text-white mb-2">Data from 3 Correction Simulations:</h3>
                         <p class="text-xs text-gray-400 mb-4">Start with your result from Step 2, then slightly change PGen and VSched to get sensitivity data.</p>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Simulation E (Current Condition)</p>
                                 <label class="text-xs">PGen In</label><input type="number" id="sg_p_in_E" class="input-field my-1" placeholder="Current PGen In">
                                 <label class="text-xs">VSched In</label><input type="number" id="sg_v_in_E" class="input-field my-1" placeholder="Current VSched In">
                                 <label class="text-xs">PGen Out</label><input type="number" id="sg_p_out_E" class="input-field my-1" placeholder="Current PGen Out">
                                 <label class="text-xs">QGen Out</label><input type="number" id="sg_q_out_E" class="input-field my-1" placeholder="Current QGen Out">
                            </div>
                            <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Simulation F (Change PGen In)</p>
                                 <label class="text-xs">PGen In</label><input type="number" id="sg_p_in_F" class="input-field my-1" placeholder="PGen In + small change">
                                 <label class="text-xs">PGen Out</label><input type="number" id="sg_p_out_F" class="input-field my-1" placeholder="Resulting PGen Out">
                                 <label class="text-xs">QGen Out</label><input type="number" id="sg_q_out_F" class="input-field my-1" placeholder="Resulting QGen Out">
                            </div>
                             <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                 <p class="font-medium text-blue-400 mb-2">Simulation G (Change VSched In)</p>
                                 <label class="text-xs">VSched In</label><input type="number" id="sg_v_in_G" class="input-field my-1" placeholder="VSched In + small change">
                                 <label class="text-xs">PGen Out</label><input type="number" id="sg_p_out_G" class="input-field my-1" placeholder="Resulting PGen Out">
                                 <label class="text-xs">QGen Out</label><input type="number" id="sg_q_out_G" class="input-field my-1" placeholder="Resulting QGen Out">
                            </div>
                         </div>
                    </div>
                    <div class="mt-6 flex flex-col md:flex-row gap-4">
                         <button id="sg_calculateFinalBtn" class="btn btn-primary w-full bg-blue-600 hover:bg-blue-700">Calculate Final Correction</button>
                         <button id="sg_resetFinalBtn" class="btn btn-secondary w-full">Reset Step 3</button>
                    </div>
                    <div id="sg_finalResultCard" class="mt-6 p-6 bg-gray-900 rounded-lg border border-gray-700 hidden">
                        <h3 class="font-semibold text-white mb-4 text-center">üèÜ Recommended Final Results:</h3>
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                            <div class="result-box text-center">
                                <p class="text-sm font-medium text-gray-400">Final PGen Input</p>
                                <p id="sg_p_in_final_result" class="text-3xl font-bold text-green-400 mt-1">-</p>
                                <p class="text-sm text-gray-500">MW</p>
                            </div>
                            <div class="result-box text-center">
                                <p class="text-sm font-medium text-gray-400">Final VSched Input</p>
                                <p id="sg_v_in_final_result" class="text-3xl font-bold text-yellow-400 mt-1">-</p>
                                <p class="text-sm text-gray-500">pu</p>
                            </div>
                        </div>
                        <p id="sg_finalErrorMessage" class="mt-4 text-red-400 text-sm font-medium text-center"></p>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="step-header">Utility: Qmax Calculator</h2>
                    <p class="text-sm text-gray-400 mb-4">Calculate the Qmax value based on the formula: Qmax = ‚àö(S¬≤ - P¬≤).</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="sg_qmax_s" class="block text-sm font-medium text-gray-300 mb-1">Apparent Power (S) in MVA</label>
                            <input type="number" id="sg_qmax_s" class="input-field" placeholder="e.g., 222.2">
                        </div>
                        <div>
                            <label for="sg_qmax_p" class="block text-sm font-medium text-gray-300 mb-1">Active Power (P) in MW</label>
                            <input type="number" id="sg_qmax_p" class="input-field" placeholder="e.g., 200.0">
                        </div>
                    </div>
                    <div class="flex items-center gap-4 mt-4">
                        <button id="sg_calculateQmaxBtn" class="btn btn-primary bg-purple-600 hover:bg-purple-700">Calculate Qmax</button>
                        <button id="sg_resetQmaxBtn" class="btn btn-secondary">Reset</button>
                    </div>
                    <div id="sg_qmaxResultCard" class="mt-6 hidden">
                        <div class="bg-gray-900 p-4 rounded-lg border border-purple-500/50 inline-block">
                            <p class="text-sm font-medium text-gray-400">Qmax Result</p>
                            <p id="sg_qmax_result" class="text-2xl font-bold text-purple-400 mt-1">-</p>
                            <p class="text-sm text-gray-500">Mvar</p>
                        </div>
                        <p id="sg_qmaxErrorMessage" class="mt-2 text-red-400 text-sm font-medium"></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Common Logic ---
        let numGenerators = 2;
        const interpolate = (y_target, x1, y1, x2, y2) => {
            if (Math.abs(y2 - y1) < 1e-9) throw new Error("Output value did not change. Try using more varied inputs.");
            return x1 + (y_target - y1) * (x2 - x1) / (y2 - y1);
        };
        const getValues = (ids) => {
            const values = {};
            let allValid = true;
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) { // Handle dynamically removed elements
                    allValid = false;
                    return;
                }
                const val = parseFloat(el.value);
                if (isNaN(val)) { el.style.borderColor = 'red'; allValid = false; } 
                else { el.style.borderColor = ''; values[id] = val; }
            });
            if (!allValid) throw new Error("Ensure all relevant fields are filled with valid numbers.");
            return values;
        };

        // --- Tab Switching Logic ---
        const tabMulti = document.getElementById('tab-multi');
        const tabSingle = document.getElementById('tab-single');
        const contentMulti = document.getElementById('multiGenCalc');
        const contentSingle = document.getElementById('singleGenCalc');

        tabMulti.addEventListener('click', () => {
            tabMulti.classList.add('active');
            tabSingle.classList.remove('active');
            contentMulti.classList.add('active');
            contentSingle.classList.remove('active');
        });
        tabSingle.addEventListener('click', () => {
            tabSingle.classList.add('active');
            tabMulti.classList.remove('active');
            contentSingle.classList.add('active');
            contentMulti.classList.remove('active');
        });
        
        // --- MULTI-GENERATOR CALCULATOR LOGIC ---

        // --- Dynamic UI Rendering ---
        const renderRatioInputs = () => {
            const container = document.getElementById('ratio_container');
            container.innerHTML = '';
            const initialValue = (100 / numGenerators).toFixed(4);
            for (let i = 1; i <= numGenerators; i++) {
                const isLast = (i === numGenerators);
                container.innerHTML += `
                    <div>
                        <label for="ratio_g${i}" class="block text-sm font-medium text-gray-300 mb-1">Gen ${i} Share (%)</label>
                        <input type="number" id="ratio_g${i}" data-idx="${i}" class="input-field ratio-input" value="${initialValue}" ${isLast ? 'readonly' : ''}>
                    </div>`;
            }
        };

        const renderPGenInputs = (sim) => {
            const container = document.getElementById(`p_in_${sim}_container`);
            container.innerHTML = '';
            for (let i = 1; i <= numGenerators; i++) {
                container.innerHTML += `
                    <div class="mb-2">
                        <label class="text-xs text-gray-400">PGen ${i} In</label>
                        <input type="number" id="p_in_${sim}${i}" data-sim="${sim}" data-idx="${i}" class="input-field mt-1 p-gen-input" placeholder="PGen ${i}" ${i > 1 ? 'readonly' : ''}>
                    </div>`;
            }
        };

        const renderPGenResults = () => {
            const container = document.getElementById('p_result_container');
            container.innerHTML = '';
            for (let i = 1; i <= numGenerators; i++) {
                container.innerHTML += `
                    <div class="result-box text-center p-4">
                        <p class="text-sm font-medium text-gray-400">Gen ${i} Input</p>
                        <p id="p_in_result_${i}" class="text-2xl font-bold text-green-400">-</p>
                        <p class="text-xs text-gray-500">MW</p>
                    </div>`;
            }
        };

        const renderPGenInputsS2 = () => {
            const container = document.getElementById('p_in_s2_container');
            container.innerHTML = '';
            for (let i = 1; i <= numGenerators; i++) {
                container.innerHTML += `<input type="number" id="p_in_${i}_s2" class="input-field" placeholder="PGen ${i}" readonly>`;
            }
        };

        const renderVSchedInputs = (sim) => {
            const container = document.getElementById(`v_in_${sim}_container`);
            container.innerHTML = '';
            const isSymmetrical = document.getElementById('symm_v_s2').checked;
            for (let i = 1; i <= numGenerators; i++) {
                 container.innerHTML += `
                    <div>
                        <label class="text-xs text-gray-400">VSched ${i} In</label>
                        <input type="number" id="v_in_${sim}${i}" data-sim="${sim}" data-idx="${i}" class="input-field mt-1 v-sched-input" placeholder="VSched ${i}" ${isSymmetrical && i > 1 ? 'readonly' : ''}>
                    </div>`;
            }
        };

        const renderFinalPGenResults = () => {
            const container = document.getElementById('p_final_result_container');
            container.innerHTML = '';
            for (let i = 1; i <= numGenerators; i++) {
                container.innerHTML += `
                    <div class="result-box text-center">
                        <p class="text-sm font-medium text-gray-400">Final PGen ${i} Input</p>
                        <p id="p_in_final_result_${i}" class="text-3xl font-bold text-green-400 mt-1">-</p>
                        <p class="text-sm text-gray-500">MW</p>
                    </div>`;
            }
        };
        
        const initMultiGenUI = () => {
            numGenerators = parseInt(document.getElementById('num_generators').value, 10);
            renderRatioInputs();
            ['A', 'B', 'E', 'F'].forEach(sim => renderPGenInputs(sim));
            renderPGenResults();
            renderPGenInputsS2();
            ['C', 'D'].forEach(sim => renderVSchedInputs(sim));
            renderFinalPGenResults();
            updateAllAsymmetricalP();
        };


        // --- Event Handlers & Logic ---
        const getRatioFactors = () => {
            const baseRatioEl = document.getElementById('ratio_g1');
            if (!baseRatioEl) return Array(numGenerators).fill(0);
            const baseRatio = parseFloat(baseRatioEl.value) || 0;
            if (baseRatio === 0) return Array(numGenerators).fill(0);
            const factors = [1.0];
            for (let i = 2; i <= numGenerators; i++) {
                const currentRatio = parseFloat(document.getElementById(`ratio_g${i}`).value) || 0;
                factors.push(currentRatio / baseRatio);
            }
            return factors;
        };
        
        const updateAllAsymmetricalP = () => {
            const factors = getRatioFactors();
            ['A', 'B', 'E', 'F'].forEach(sim => {
                const pGen1El = document.getElementById(`p_in_${sim}1`);
                if (pGen1El) {
                    const pGen1Val = parseFloat(pGen1El.value);
                    if (!isNaN(pGen1Val)) {
                        for (let i = 2; i <= numGenerators; i++) {
                            const targetEl = document.getElementById(`p_in_${sim}${i}`);
                            if(targetEl) targetEl.value = (pGen1Val * factors[i-1]).toFixed(10);
                        }
                    } else {
                         for (let i = 2; i <= numGenerators; i++) {
                            const targetEl = document.getElementById(`p_in_${sim}${i}`);
                            if(targetEl) targetEl.value = '';
                        }
                    }
                }
            });
        };

        const handleRatioChange = () => {
            let sum = 0;
            const ratioInputs = document.querySelectorAll('#ratio_container .ratio-input');
            for (let i = 0; i < numGenerators - 1; i++) {
                 sum += parseFloat(ratioInputs[i].value) || 0;
            }
            if (sum > 100) sum = 100;
            if(ratioInputs[numGenerators - 1]) {
                ratioInputs[numGenerators - 1].value = (100 - sum).toFixed(4);
            }
            updateAllAsymmetricalP();
        };

        const handleSymmetryChange = () => {
            ['C', 'D'].forEach(sim => renderVSchedInputs(sim));
        };
        
        // --- Global Target Sync Logic ---
        const globalPTarget = document.getElementById('global_p_target');
        const globalQTarget = document.getElementById('global_q_target');
        globalPTarget.addEventListener('input', () => {
            document.getElementById('p_out_target_s1').value = globalPTarget.value;
            document.getElementById('p_out_target_s3').value = globalPTarget.value;
        });
        globalQTarget.addEventListener('input', () => {
            document.getElementById('q_out_target_s2').value = globalQTarget.value;
            document.getElementById('q_out_target_s3').value = globalQTarget.value;
        });

        // --- Step 1: PGen Calculation ---
        document.getElementById('calculatePBtn').addEventListener('click', () => {
            const resultCard = document.getElementById('pResultCard');
            const errorEl = document.getElementById('pErrorMessage');
            resultCard.classList.remove('hidden');
            try {
                const v = getValues(['p_out_target_s1', 'p_in_A1', 'p_out_A', 'p_in_B1', 'p_out_B']);
                const p_in_target_1 = interpolate(v.p_out_target_s1, v.p_in_A1, v.p_out_A, v.p_in_B1, v.p_out_B);
                const factors = getRatioFactors();
                
                for(let i=1; i<=numGenerators; i++){
                     document.getElementById(`p_in_result_${i}`).textContent = (p_in_target_1 * factors[i-1]).toFixed(10);
                }
                errorEl.textContent = '';
                document.getElementById('pNextStep').classList.remove('hidden');
            } catch (e) {
                 for(let i=1; i<=numGenerators; i++) {
                     const el = document.getElementById(`p_in_result_${i}`);
                     if (el) el.textContent = '-';
                 }
                errorEl.textContent = e.message;
                document.getElementById('pNextStep').classList.add('hidden');
            }
        });

        document.getElementById('useForStep2Btn').addEventListener('click', () => {
            const p1 = document.getElementById('p_in_result_1').textContent;
            if (p1 !== '-') {
                for(let i=1; i<=numGenerators; i++){
                    document.getElementById(`p_in_${i}_s2`).value = document.getElementById(`p_in_result_${i}`).textContent;
                }
                document.getElementById('p_in_1_s2').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                 alert("Please calculate a valid result in Step 1 first.");
            }
        });
        
        // --- Step 2: QGen Calculation ---
        document.getElementById('calculateQBtn').addEventListener('click', () => {
            const resultCard = document.getElementById('qResultCard');
            const errorEl = document.getElementById('qErrorMessage');
            resultCard.classList.remove('hidden');
            try {
                const pGenInputsS2 = Array.from({length: numGenerators}, (_, i) => `p_in_${i+1}_s2`);
                const v = getValues([...pGenInputsS2, 'q_out_target_s2', 'v_in_C1', 'q_out_C', 'v_in_D1', 'q_out_D']);
                const v_in_target = interpolate(v.q_out_target_s2, v.v_in_C1, v.q_out_C, v.v_in_D1, v.q_out_D);
                document.getElementById('v_in_result').textContent = v_in_target.toFixed(10);
                errorEl.textContent = '';
            } catch (e) {
                document.getElementById('v_in_result').textContent = '-';
                errorEl.textContent = e.message;
            }
        });

        document.getElementById('useForStep3Btn').addEventListener('click', () => {
            const vInResult = document.getElementById('v_in_result').textContent;
            if (vInResult !== '-') {
                const factors = getRatioFactors();
                const p1_s2_val = parseFloat(document.getElementById('p_in_1_s2').value);
                if(isNaN(p1_s2_val)) {
                    alert("Please complete Step 1 first.");
                    return;
                }
                for(let i=1; i<=numGenerators; i++){
                     document.getElementById(`p_in_E${i}`).value = (p1_s2_val * factors[i-1]).toFixed(10);
                }
                document.getElementById('v_in_E').value = parseFloat(vInResult).toFixed(10);
                document.getElementById('p_in_E1').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert("Please complete Steps 1 and 2 first.");
            }
        });
        
        // --- Step 3: Final Correction ---
        document.getElementById('calculateFinalBtn').addEventListener('click', () => {
             const resultCard = document.getElementById('finalResultCard');
             const errorEl = document.getElementById('finalErrorMessage');
             resultCard.classList.remove('hidden');
             try {
                const v = getValues(['p_out_target_s3', 'q_out_target_s3', 'p_in_E1', 'v_in_E', 'p_out_E', 'q_out_E', 'p_in_F1', 'p_out_F', 'q_out_F', 'v_in_G', 'p_out_G', 'q_out_G']);
                const dp_in = v.p_in_F1 - v.p_in_E1;
                const dv_in = v.v_in_G - v.v_in_E;
                if (Math.abs(dp_in) < 1e-6 || Math.abs(dv_in) < 1e-6) throw new Error("Input change for simulation F or G is too small.");
                const J11 = (v.p_out_F - v.p_out_E) / dp_in;
                const J21 = (v.q_out_F - v.q_out_E) / dp_in;
                const J12 = (v.p_out_G - v.p_out_E) / dv_in;
                const J22 = (v.q_out_G - v.q_out_E) / dv_in;
                const determinant = J11 * J22 - J12 * J21;
                if (Math.abs(determinant) < 1e-9) throw new Error("System cannot be solved (singular matrix). Try different input changes.");
                const error_p = v.p_out_target_s3 - v.p_out_E;
                const error_q = v.q_out_target_s3 - v.q_out_E;
                const delta_p_in = (J22 * error_p - J12 * error_q) / determinant;
                const delta_v_in = (-J21 * error_p + J11 * error_q) / determinant;
                const p_final_1 = v.p_in_E1 + delta_p_in;
                const v_final = v.v_in_E + delta_v_in;
                const factors = getRatioFactors();

                for(let i=1; i<=numGenerators; i++) {
                    const el = document.getElementById(`p_in_final_result_${i}`);
                    if(el) el.textContent = (p_final_1 * factors[i-1]).toFixed(10);
                }
                document.getElementById('v_in_final_result').textContent = v_final.toFixed(10);
                errorEl.textContent = '';
             } catch(e) {
                for(let i=1; i<=numGenerators; i++) {
                    const el = document.getElementById(`p_in_final_result_${i}`);
                    if(el) el.textContent = '-';
                }
                document.getElementById('v_in_final_result').textContent = '-';
                errorEl.textContent = e.message;
             }
        });

        // --- Event Listeners Setup ---
        document.getElementById('num_generators').addEventListener('change', initMultiGenUI);
        document.querySelector('body').addEventListener('input', (e) => {
            if (e.target.classList.contains('ratio-input')) handleRatioChange();
            if (e.target.id === 'p_in_A1' || e.target.id === 'p_in_B1' || e.target.id === 'p_in_E1' || e.target.id === 'p_in_F1') updateAllAsymmetricalP();
            if (e.target.id === 'symm_v_s2') handleSymmetryChange();
            if (e.target.classList.contains('v-sched-input') && document.getElementById('symm_v_s2').checked && e.target.dataset.idx === '1') {
                const sim = e.target.dataset.sim;
                for(let i = 2; i <= numGenerators; i++) {
                    const el = document.getElementById(`v_in_${sim}${i}`);
                    if(el) el.value = e.target.value;
                }
            }
        });
        
        // --- Reset and Utility Buttons ---
        const resetAllMultiGen = () => {
            document.getElementById('global_p_target').value = '';
            document.getElementById('global_q_target').value = '';
            document.getElementById('global_p_target').dispatchEvent(new Event('input'));
            document.getElementById('num_generators').value = '2';
            initMultiGenUI();
            ['pResultCard', 'qResultCard', 'finalResultCard', 'qmaxResultCard'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('qmax_s').value = '';
            document.getElementById('qmax_p').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        document.getElementById('resetAllBtn').addEventListener('click', resetAllMultiGen);
        document.getElementById('resetPBtn').addEventListener('click', () => {
             ['A','B'].forEach(sim => {
                for(let i=1; i<=numGenerators; i++) {
                    const el = document.getElementById(`p_in_${sim}${i}`);
                    if (el) el.value = '';
                }
            });
            document.getElementById('p_out_A').value = '';
            document.getElementById('p_out_B').value = '';
            document.getElementById('pResultCard').classList.add('hidden');
        });
        document.getElementById('resetQBtn').addEventListener('click', () => {
            for(let i=1; i<=numGenerators; i++) {
                const el = document.getElementById(`p_in_${i}_s2`);
                if(el) el.value = '';
            }
            ['C','D'].forEach(sim => {
                for(let i=1; i<=numGenerators; i++) {
                    const el = document.getElementById(`v_in_${sim}${i}`);
                    if(el) el.value = '';
                }
            });
            document.getElementById('q_out_C').value = '';
            document.getElementById('q_out_D').value = '';
            document.getElementById('qResultCard').classList.add('hidden');
        });
        document.getElementById('resetFinalBtn').addEventListener('click', () => {
             ['E','F'].forEach(sim => {
                for(let i=1; i<=numGenerators; i++) {
                    const el = document.getElementById(`p_in_${sim}${i}`);
                    if (el) el.value = '';
                }
            });
            ['E','F','G'].forEach(sim => {
                const pOutEl = document.getElementById(`p_out_${sim}`);
                if (pOutEl) pOutEl.value = '';
                const qOutEl = document.getElementById(`q_out_${sim}`);
                if (qOutEl) qOutEl.value = '';
            });
            document.getElementById('v_in_E').value = '';
            document.getElementById('v_in_G').value = '';
            document.getElementById('finalResultCard').classList.add('hidden');
        });
        document.getElementById('calculateQmaxBtn').addEventListener('click', () => {
            try {
                const v = getValues(['qmax_s', 'qmax_p']);
                if (v.qmax_s < Math.abs(v.qmax_p)) throw new Error("S must be >= |P|.");
                const qmax = Math.sqrt(v.qmax_s*v.qmax_s - v.qmax_p*v.qmax_p);
                document.getElementById('qmax_result').textContent = qmax.toFixed(10);
                document.getElementById('qmaxErrorMessage').textContent = '';
            } catch (e) {
                document.getElementById('qmax_result').textContent = '-';
                document.getElementById('qmaxErrorMessage').textContent = e.message;
            }
            document.getElementById('qmaxResultCard').classList.remove('hidden');
        });
        document.getElementById('resetQmaxBtn').addEventListener('click', () => {
            document.getElementById('qmax_s').value = '';
            document.getElementById('qmax_p').value = '';
            document.getElementById('qmaxResultCard').classList.add('hidden');
        });


        // --- SINGLE GENERATOR LOGIC ---
        document.getElementById('sg_calculatePBtn').addEventListener('click', () => {
            const resultCard = document.getElementById('sg_pResultCard');
            const errorEl = document.getElementById('sg_pErrorMessage');
            resultCard.classList.remove('hidden');
            try {
                const v = getValues(['sg_p_out_target_global', 'sg_p_in_A', 'sg_p_out_A', 'sg_p_in_B', 'sg_p_out_B']);
                const p_in_target = interpolate(v.sg_p_out_target_global, v.sg_p_in_A, v.sg_p_out_A, v.sg_p_in_B, v.sg_p_out_B);
                document.getElementById('sg_p_in_result').textContent = p_in_target.toFixed(10);
                errorEl.textContent = '';
                document.getElementById('sg_pNextStep').classList.remove('hidden');
            } catch (e) {
                document.getElementById('sg_p_in_result').textContent = '-';
                errorEl.textContent = e.message;
                document.getElementById('sg_pNextStep').classList.add('hidden');
            }
        });
        document.getElementById('sg_calculateQBtn').addEventListener('click', () => {
            const resultCard = document.getElementById('sg_qResultCard');
            const errorEl = document.getElementById('sg_qErrorMessage');
            resultCard.classList.remove('hidden');
            try {
                const v = getValues(['sg_p_in_s2', 'sg_q_out_target_global', 'sg_v_in_C', 'sg_q_out_C', 'sg_v_in_D', 'sg_q_out_D']);
                const v_in_target = interpolate(v.sg_q_out_target_global, v.sg_v_in_C, v.sg_q_out_C, v.sg_v_in_D, v.sg_q_out_D);
                document.getElementById('sg_v_in_result').textContent = v_in_target.toFixed(10);
                errorEl.textContent = '';
            } catch (e) {
                document.getElementById('sg_v_in_result').textContent = '-';
                errorEl.textContent = e.message;
            }
        });
        document.getElementById('sg_useForStep3Btn').addEventListener('click', () => {
            const pInS2 = document.getElementById('sg_p_in_s2').value;
            const vInResult = document.getElementById('sg_v_in_result').textContent;
            if (pInS2 && vInResult !== '-') {
                document.getElementById('sg_p_in_E').value = parseFloat(pInS2).toFixed(10);
                document.getElementById('sg_v_in_E').value = parseFloat(vInResult).toFixed(10);
                document.getElementById('sg_p_in_E').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else { alert("Please calculate a valid result in Step 2 first."); }
        });
        document.getElementById('sg_calculateFinalBtn').addEventListener('click', () => {
             const resultCard = document.getElementById('sg_finalResultCard');
             const errorEl = document.getElementById('sg_finalErrorMessage');
             resultCard.classList.remove('hidden');
             try {
                const v = getValues(['sg_p_out_target_global', 'sg_q_out_target_global', 'sg_p_in_E', 'sg_v_in_E', 'sg_p_out_E', 'sg_q_out_E', 'sg_p_in_F', 'sg_p_out_F', 'sg_q_out_F', 'sg_v_in_G', 'sg_p_out_G', 'sg_q_out_G']);
                const dp_in = v.sg_p_in_F - v.sg_p_in_E;
                const dv_in = v.sg_v_in_G - v.sg_v_in_E;
                if (Math.abs(dp_in) < 1e-6 || Math.abs(dv_in) < 1e-6) throw new Error("Input change for simulation F or G is too small.");
                const J11 = (v.sg_p_out_F - v.sg_p_out_E) / dp_in;
                const J21 = (v.sg_q_out_F - v.sg_q_out_E) / dp_in;
                const J12 = (v.sg_p_out_G - v.sg_p_out_E) / dv_in;
                const J22 = (v.sg_q_out_G - v.sg_q_out_E) / dv_in;
                const determinant = J11 * J22 - J12 * J21;
                if (Math.abs(determinant) < 1e-9) throw new Error("System cannot be solved (singular matrix).");
                const error_p = v.sg_p_out_target_global - v.sg_p_out_E;
                const error_q = v.sg_q_out_target_global - v.sg_q_out_E;
                const delta_p_in = (J22 * error_p - J12 * error_q) / determinant;
                const delta_v_in = (-J21 * error_p + J11 * error_q) / determinant;
                document.getElementById('sg_p_in_final_result').textContent = (v.sg_p_in_E + delta_p_in).toFixed(10);
                document.getElementById('sg_v_in_final_result').textContent = (v.sg_v_in_E + delta_v_in).toFixed(10);
                errorEl.textContent = '';
             } catch(e) {
                document.getElementById('sg_p_in_final_result').textContent = '-';
                document.getElementById('sg_v_in_final_result').textContent = '-';
                errorEl.textContent = e.message;
             }
        });
        document.getElementById('sg_calculateQmaxBtn').addEventListener('click', () => {
            try {
                const v = getValues(['sg_qmax_s', 'sg_qmax_p']);
                if (v.sg_qmax_s < Math.abs(v.sg_qmax_p)) throw new Error("S must be >= |P|.");
                const qmax = Math.sqrt(v.sg_qmax_s*v.sg_qmax_s - v.sg_qmax_p*v.sg_qmax_p);
                document.getElementById('sg_qmax_result').textContent = qmax.toFixed(10);
                document.getElementById('sg_qmaxErrorMessage').textContent = '';
            } catch (e) {
                document.getElementById('sg_qmax_result').textContent = '-';
                document.getElementById('sg_qmaxErrorMessage').textContent = e.message;
            }
            document.getElementById('sg_qmaxResultCard').classList.remove('hidden');
        });
        document.getElementById('sg_resetQmaxBtn').addEventListener('click', () => {
            document.getElementById('sg_qmax_s').value = '';
            document.getElementById('sg_qmax_p').value = '';
            document.getElementById('sg_qmaxResultCard').classList.add('hidden');
        });
         document.getElementById('sg_resetAllBtn').addEventListener('click', () => {
            document.getElementById('sg_p_out_target_global').value = '';
            document.getElementById('sg_q_out_target_global').value = '';
            ['sg_p_in_A', 'sg_p_out_A', 'sg_p_in_B', 'sg_p_out_B', 'sg_p_in_s2', 'sg_v_in_C', 'sg_q_out_C', 'sg_v_in_D', 'sg_q_out_D','sg_p_in_E', 'sg_v_in_E', 'sg_p_out_E', 'sg_q_out_E', 'sg_p_in_F', 'sg_p_out_F', 'sg_q_out_F', 'sg_v_in_G', 'sg_p_out_G', 'sg_q_out_G', 'sg_qmax_s', 'sg_qmax_p'].forEach(id => document.getElementById(id).value = '');
            ['sg_pResultCard', 'sg_qResultCard', 'sg_finalResultCard', 'sg_qmaxResultCard'].forEach(id => document.getElementById(id).classList.add('hidden'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initial Page Load
        initMultiGenUI();
    });
    </script>
</body>
</html>

